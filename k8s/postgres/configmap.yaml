apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-init-cm
  namespace: data-platform
data:
  init.sql: |
    -- Create products table
    CREATE TABLE products (
        id BIGSERIAL PRIMARY KEY,
        name VARCHAR(255) NOT NULL,
        price DECIMAL(10, 2) NOT NULL,
        description TEXT,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    );

    -- Create orders table
    CREATE TABLE orders (
        id BIGSERIAL PRIMARY KEY,
        user_id BIGINT NOT NULL,
        status VARCHAR(50) NOT NULL,
        total_price DECIMAL(10, 2) NOT NULL,
        ordered_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    );

    -- Create order_items table
    CREATE TABLE order_items (
        id BIGSERIAL PRIMARY KEY,
        order_id BIGINT NOT NULL REFERENCES orders(id) ON DELETE CASCADE,
        product_id BIGINT NOT NULL,
        quantity INT NOT NULL,
        unit_price DECIMAL(10, 2) NOT NULL,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    );

    -- Create indexes for better query performance
    CREATE INDEX idx_order_items_order_id ON order_items(order_id);
    CREATE INDEX idx_order_items_product_id ON order_items(product_id);

    -- Insert some sample products for testing
    INSERT INTO products (name, price, description) VALUES
    ('Laptop', 1200.00, 'High-performance laptop'),
    ('Mouse', 25.00, 'Wireless mouse'),
    ('Keyboard', 75.00, 'Mechanical keyboard'),
    ('Monitor', 350.00, '27-inch 4K monitor'),
    ('Headphones', 150.00, 'Noise-cancelling headphones');
